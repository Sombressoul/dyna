# Алгоритм: **T_PD_MF_QTail** (DRAFT)

T-field, Poisson-Dual, Matrx-Free, Quatrature-Tail.

---

## 1. Данные и обозначения

* Размерность: $D=2N$.
* Точка замера: $z\in\mathbb C^N$ (эквивалентно $x\in\mathbb R^D$).
* Источник $j$: $(z_j,\ d_j,\ \sigma_{\parallel,j},\ \sigma_{\perp,j},\ \alpha_j,\ T_{\hat j})$.
* Единичное направление: $u_j := d_j/\|d_j\|$.
* Сдвиг в позиции: $x := z_j - z\in\mathbb R^D$, радиус $r := \|x\|$, продольная проекция $c := \langle x,u_j\rangle$.
* Параметры анизотропии (реальное пространство, **без матриц**):

  $$
  a := \sigma_{\perp,j}^{-2},\qquad b := \sigma_{\parallel,j}^{-2}-\sigma_{\perp,j}^{-2}.
  $$
* Ранг-1 метрика: $G := aI + b\,u_j u_j^\top$.
* Число $\nu := \frac{D}{2}-1$. Площадь единичной сферы: $C_D := \dfrac{2\pi^{D/2}}{\Gamma(D/2)}$.

---

## 2. Позиционный «текущий фрейм» $n=0$ (точно, без матриц)

Записываем **без поворотов** через норму и проекцию:

$$
A_{\text{pos}}(z) \;=\; \exp\!\Big(-\pi\Big[\tfrac{|c|^2}{\sigma_{\parallel,j}^2}
+\tfrac{r^2-|c|^2}{\sigma_{\perp,j}^2}\Big]\Big)
\;=\; \exp\!\big(-\pi\,x^\top G\,x\big).
$$

Это — точный вклад «текущего» периодического образа $n=0$.

---

## 3. Реальная периодизация: разложение «$n=0$ + хвост»

Полная периодическая сумма в реальном пространстве:

$$
\Theta^{(\mathrm{pos})}(x)
=\underbrace{e^{-\pi\,x^\top G x}}_{n=0}
+\underbrace{\sum_{n\in\mathbb Z^D\setminus\{0\}} e^{-\pi\,(x+n)^\top G (x+n)}}_{\Theta^{\mathrm{tail}}_{\mathrm{real}}(x)}.
$$

Мы считаем её как

$$
\Theta^{(\mathrm{pos})}(x)= A_{\text{pos}}(z)\,\Big[\,1 + \mathcal T(x)\,\Big],
$$

где «хвостовое отношение»

$$
\mathcal T(x)
=\sum_{n\in\mathbb Z^D\setminus\{0\}}
\exp\!\Big(-\pi\,n^\top G n\Big)\;
\exp\!\Big(-2\pi\,x^\top G n\Big).
$$

---

## 4. Квадратурная аппроксимация хвоста $\mathcal T(x)$

Идея: заменить дискретный хвост **сферически усреднённым интегралом по радиусу** и взять его **1D-квадратурой Гаусса–Лагерра**. Всё — без матриц, только нормы и проекции.

### 4.1. Подготовка к угловому усреднению

Для каждого радиуса $\rho=\|n\|$ положим:

$$
n^\top G n = a\,\rho^2 + b\,\rho^2\cos^2\theta,\qquad
x^\top G n = \underbrace{a\,x + b\,c\,u_j}_{=:v}\ \cdot\ n,
$$

где $\cos\theta=\frac{\langle n,u_j\rangle}{\rho}$, $c=\langle x,u_j\rangle$, а

$$
v \;=\; a\,x + b\,c\,u_j,\qquad m:=\|v\|.
$$

Тогда

$$
\exp\!\big(-2\pi\,x^\top G n\big)=\exp\!\big(-2\pi\,m\,\rho\ \cos\phi\big),
$$

где $\phi$ — угол между $v$ и $n$.

### 4.2. Два угловых усреднения (по сфере $S^{D-1}$)

1. Квадратичный анизотропный множитель:

$$
\Big\langle e^{-\pi\,b\,\rho^2\cos^2\theta}\Big\rangle_{\text{угол}}
=\;{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};\,-\pi b\,\rho^2\Big).
$$

2. Линейный (радиальный) множитель (известная сферическая формула):

$$
\Big\langle e^{-2\pi\,m\,\rho\,\cos\phi}\Big\rangle_{\text{угол}}
=\Gamma\!\Big(\tfrac{D}{2}\Big)\,\Big(\tfrac{2}{2\pi m\rho}\Big)^{\!\nu}\!
I_{\nu}(2\pi m\rho),
$$

где $I_\nu$ — модифицированная функция Бесселя первого рода.

**Аппроксимация хвоста усреднением.** Заменяя суммирование по узлам решётки на сферически усреднённую «плотность» по радиусу, получаем:

$$
\mathcal T(x)\ \approx\ C_D \int_{0}^{\infty}
\rho^{D-1}\;e^{-\pi a\,\rho^2}\;
{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};\,-\pi b\,\rho^2\Big)\;
\Gamma\!\Big(\tfrac{D}{2}\Big)\Big(\tfrac{2}{2\pi m\rho}\Big)^{\!\nu}
I_{\nu}(2\pi m\rho)\;d\rho.
$$

### 4.3. Приведение к форме Лагерра (1D-квадратура)

Сделаем замену

$$
u \;=\; \pi a\,\rho^2\quad\Longrightarrow\quad
\rho=\sqrt{\tfrac{u}{\pi a}},\ \ \ d\rho=\frac{du}{2\sqrt{\pi a\,u}}.
$$

Тогда

$$
\rho^{D-1}d\rho
=\frac{1}{2}(\pi a)^{-D/2}\,u^{\nu}\,du.
$$

Обозначим

$$
\kappa:=\frac{b}{a}\ (\text{безразмерная анизотропия}),\qquad
\zeta(u):=2\pi m\sqrt{\frac{u}{\pi a}}\;=\;2\sqrt{\pi}\,m\,a^{-1/2}\,u^{1/2}.
$$

Получаем **каноническую форму для Гаусса–Лагерра** (вес $u^{\nu}e^{-u}$):

$$
\boxed{\;
\mathcal T(x)\ \approx\ K_D(a)\!
\int_{0}^{\infty}\! u^{\nu}e^{-u}\;
\Phi_{Q}(u;\,m,a,\kappa)\,du\;},
$$

где

$$
K_D(a)\;=\;\frac{C_D}{2}\,(\pi a)^{-D/2}\,\Gamma\!\Big(\tfrac{D}{2}\Big)\,2^{\nu},\qquad
\Phi_{Q}(u;\,m,a,\kappa)\;=\;
{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};\,-\kappa\,u\Big)\;
\zeta(u)^{-\nu}\,I_{\nu}\!\big(\zeta(u)\big).
$$

**Квадратура Гаусса–Лагерра.** Пусть $\{(u_q,w_q^{(\nu)})\}_{q=1}^Q$ — узлы/веса GL с параметром $\alpha=\nu$. Тогда

$$
\boxed{\;
\mathcal T(x)\ \approx\ K_D(a)\,\sum_{q=1}^{Q} w_q^{(\nu)}\;\Phi_{Q}\!\big(u_q;\,m,a,\kappa\big)\; }.
$$

Итого позиционная периодизация:

$$
\boxed{\;\Theta^{(\mathrm{pos})}(x)\ \approx\ A_{\text{pos}}(z)\,\Big[1+K_D(a)\sum_{q=1}^{Q} w_q^{(\nu)}\,\Phi_{Q}(u_q;\,m,a,\kappa)\Big].\;}
$$

Все величины $m,a,\kappa$ выражены через **нормы и проекции**:

$$
m \;=\; \big\|a\,x + b\,c\,u_j\big\|,
\quad a=\sigma_{\perp}^{-2},
\quad b=\sigma_{\parallel}^{-2}-\sigma_{\perp}^{-2},
\quad \kappa=\frac{b}{a}.
$$

---

## 5. Направленческий множитель (домножается один раз)

Определён в каноне как

$$
A_{\mathrm{dir},j}\;=\;\mathcal A\!\big(\mathrm{delta_vec_d}(d,\ d_j)\big),
$$

и **не периодизуется**. Домножается один раз к позиционной части.

---

## 6. Вклад источника и итоговое поле

Для источника $j$ в точке $z$:

$$
\mathrm{contrib}_j(z)
\;=\;\alpha_j\;\Big(T_{\hat j}\cdot \Theta^{(\mathrm{pos})}(z_j{-}z)\Big)\;\cdot A_{\mathrm{dir},j}.
$$

Поле:

$$
T(z,\cdot)\;=\;\sum_{j=1}^{M}\mathrm{contrib}_j(z)
\quad\text{(при необходимости берём }\Re\{\cdot\}\text{ на финальном шаге).}
$$

---

## 7. Почему это должно работать (строгие аргументы и аппроксимационные факты)

1. **Точный «текущий фрейм».** Член $n=0$ $=\ e^{-\pi x^\top G x}$ вычисляется **строго** и без матриц через одну норму и одну проекцию; это эквивалентно «повороту+диагонали».

2. **Строгая декомпозиция реальной периодизации.** Представление

$$
\Theta^{(\mathrm{pos})}(x)=e^{-\pi x^\top G x}+\sum_{n\neq 0}e^{-\pi(x+n)^\top G(x+n)}
$$

тождественно. Мы аппроксимируем **только хвост**.

3. **Сферическое усреднение хвоста.** На больших $\rho$ вклад узлов решётки с нормой $\rho$ близок к вкладy «сферической оболочки» радиуса $\rho$. Для гауссового ядра погрешность замены «сумма по узлам оболочки» $\to$ «сферическое усреднение» убывает быстрее любой степени по $\rho$ (экспоненциально за счёт $e^{-\pi a\rho^2}$).

4. **Угловые интегралы — замкнутые формы.**

   * Квадратичный анизотропный множитель даёт ${}_1F_1(\tfrac12;\tfrac D2;-\pi b\rho^2)$.
   * Линейный множитель $e^{-2\pi v\cdot n}$ даёт модифицированный Бессель $I_\nu(2\pi m\rho)$ с $\nu=\tfrac{D}{2}-1$. Эти формулы — классические сферические средние.

5. **Редукция к 1D-квадратуре.** Замена $u=\pi a\rho^2$ приводит интеграл к стандартной форме Гаусса–Лагерра (вес $u^{\nu}e^{-u}$), что обеспечивает **суперлинейную** сходимость по числу узлов $Q$.

6. **Матрицы не нужны.** Все скаляры $a,b,\kappa,m$ считаются из $\sigma_{\parallel,\perp}$, $x$, $u_j$ через нормы и проекции. Ни $D\times D$ объектов, ни решёток оффсетов в памяти.

**Итог:** алгоритм даёт контролируемую ε-точность за счёт (i) экспоненциальной малости хвоста и (ii) суперлинейной сходимости 1D-квадратуры. Точный текущий фрейм складывается с интегральной оценкой хвоста, полученной строгим сферическим усреднением и редукцией к одномерной GL-квадратуре.

---

## 8. Краткий чек-лист реализации (строго по шагам)

1. Входные данные $\to$ $u_j,\,x,\,r,\,c$.
2. Константы: $a=\sigma_{\perp}^{-2},\ b=\sigma_{\parallel}^{-2}-\sigma_{\perp}^{-2},\ \nu=D/2-1,\ C_D$.
3. **Точный** $A_{\text{pos}}=\exp\!\big(-\pi[|c|^2/\sigma_{\parallel}^2+(r^2-|c|^2)/\sigma_{\perp}^2]\big)$.
4. $v=a x + b c u_j$, $m=\|v\|$.
5. Подготовить узлы/веса GL $\{(u_q,w_q^{(\nu)})\}_{q=1}^Q$.
6. Вычислить

   $$
   S:=K_D(a)\sum_{q=1}^{Q} w_q^{(\nu)}\;{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};-\kappa\,u_q\Big)\;
   \zeta(u_q)^{-\nu}\,I_\nu\!\big(\zeta(u_q)\big),
   $$

   где $\kappa=b/a$, $\zeta(u)=2\sqrt{\pi}\,m\,a^{-1/2}\,u^{1/2}$, $K_D(a)=\dfrac{C_D}{2}(\pi a)^{-D/2}\Gamma(\tfrac{D}{2})\,2^{\nu}$.
7. $\Theta^{(\mathrm{pos})}\approx A_{\text{pos}}\,(1+S)$.
8. Домножить $A_{\mathrm{dir},j}=\mathcal A(\mathrm{delta_vec_d}(d,d_j))$ **один раз** и собрать вклад $\mathrm{contrib}_j=\alpha_j\,(T_{\hat j}\cdot \Theta^{(\mathrm{pos})})\cdot A_{\mathrm{dir},j}$.
9. Просуммировать по $j$.

Это и есть **T_PD_MF_QTail**: «текущий фрейм» точно, хвост — одной 1D-квадратурой, никаких матриц и решёток, строгое разложение в реальном пространстве и аналитическое угловое усреднение для хвоста.

---

# Модификация QTail: точная 1F1 без спецфункции, скейленный Бессель и «остаточный» интегранд

## 1) Область применения

* Радикальная часть (радиальная интеграция по $u$) хвостового вклада после точного нулевого фрейма.
* Все параметры анизотропии входят **линейно** по $1/\sigma$; это сохраняется.

## 2) Точная замена гипергеометрии (без вызова 1F1)

Для целочисленных $N$ используем **строгое тождество**:

$$
{}_1F_1\!\Big(\tfrac12;N;-x\Big)\;\equiv\;
A_N\,\mathrm{erfc}(\sqrt{x})\;+\;e^{-x}\,x^{\frac12-N}\,P_{N-1}(x),
\quad x=\kappa u\ge0,
$$

где $A_N$ — скаляр, а $P_{N-1}(x)=\sum_{k=0}^{N-1}c_k\,x^k$ — конечный полином, **зависящие только от $N$**. Для численной устойчивости используем форму

$$
\mathrm{erfc}(\sqrt{x})=e^{-x}\,\mathrm{erfcx}(\sqrt{x})\;\Rightarrow\;
{}_1F_1\!\Big(\tfrac12;N;-x\Big)=
e^{-x}\Big[ A_N\,\mathrm{erfcx}(\sqrt{x}) + x^{\frac12-N}P_{N-1}(x)\Big].
$$

* **Малые $x$**: в окрестности нуля значение берём **по ряду Маклорена** $\sum_{k\ge0}\frac{(\frac12)_k}{(N)_k}\frac{(-x)^k}{k!}$; это обеспечивает $ {}_1F_1(\tfrac12;N;0)=1$ и снимает искусственную сингулярность степени $x^{\frac12-N}$.
* **Реализация полинома**: полностью векторная, без Python-циклов (через `cumprod+einsum`); при необходимости допускается стриминг по последней оси.

## 3) Угловой множитель: скейленная форма $\widetilde I_\nu$

Угловое усреднение сохраняет канон с $I_\nu$ (заменять семейством иных функций **не требуется и нецелесообразно**). Для устойчивости:

$$
\widetilde I_\nu(\zeta)\;:=\;e^{-\zeta}\,I_\nu(\zeta),
$$

и вся экспонента интегранда фактически сводится к **одному** множителю $e^{-(1+\kappa)u}$ (см. ниже). Вычисление $\widetilde I_\nu$ — кусочно, **без циклов**:

* малые $\zeta$: степенной ряд (векторно, через `cumprod`/`einsum`);
* средние $\zeta$: минимакс/Чебышёв по $\log\zeta$ на фиксированном интервале (готовые коэффициенты; одна редукция);
* большие $\zeta$: дебаевская асимптотика для $\widetilde I_\nu$ (полином в $1/\zeta$).

## 4) Остаточный интегранд (разность с нулевым фреймом)

Пусть $\mathcal{H}_{\text{act}}(u)$ — «ядро» фактического кадра, $\mathcal{H}_0(u)$ — «ядро» нулевого фрейма (оба включают угловую часть). Тогда хвостовой интегранд:

$$
\boxed{\;
\mathcal{I}_{\text{tail}}(u)
=
\underbrace{e^{-u}\,e^{-\kappa u}\Big[ A_N\,\mathrm{erfcx}(\sqrt{\kappa u}) + (\kappa u)^{\frac12-N}P_{N-1}(\kappa u)\Big]}_{\text{точная 1F1 без спецфункции}}
\cdot \underbrace{\widetilde I_\nu\big(\zeta(u)\big)}_{\text{скейленный Бессель}}
\;-\;
\underbrace{e^{-u}\,\mathcal{H}_0(u)}_{\text{нулевой фрейм}}
\;}
$$

или, собирая экспоненты,

$$
\mathcal{I}_{\text{tail}}(u)
=
e^{-(1+\kappa)u}\,\Big[ A_N\,\mathrm{erfcx}(\sqrt{\kappa u}) + (\kappa u)^{\frac12-N}P_{N-1}(\kappa u)\Big]\;\widetilde I_\nu\big(\zeta(u)\big)
\;-\;e^{-u}\,\mathcal{H}_0(u).
$$

Здесь $\kappa$ и $\zeta(u)$ — **линейны по $1/\sigma$**; разность «актуал–нулевой» даёт **жёсткое затухание** и снижает радиус интегрирования.

## 5) Радиальное обрезание хвоста $U_\star$ с контролем остатка

Верхняя оценка на модуль интегранда из (4) приводит к универсальной форме

$$
|\mathcal{I}_{\text{tail}}(u)|\ \le\ e^{-(1+\kappa)u}\,\Big[ C_0\,u^{-1/2} + \sum_{k=0}^{N-1} C_k\,u^{k+\frac12-N}\Big],
$$

где $C_0,C_k$ — известные по $A_N$, $\kappa$, нормам аппроксимации $\widetilde I_\nu$ и коэффициентам $P_{N-1}$. Остаток на $[U_\star,\infty)$ выражается через элементарные одночлены (или неполные гаммы) и даёт неравенство вида

$$
e^{-(1+\kappa)U_\star}\,\sum_j D_j\,U_\star^{\beta_j}\ \le\ \varepsilon,
$$

из которого выбирается $U_\star$ (одна–две итерации по скаляру; **без** «магических» констант — всё через реальные $D_j,\beta_j$ и целевой допуск $\varepsilon$).

## 6) Алгоритмический скетч (радиальная часть)

1. Построить узлы/веса GL на $[0,U_\star]$ (общий $Q$ или пер-объектный $U_\star$).
2. На каждом узле $u_q$ векторно вычислить:

   * $x_q=\kappa u_q$ и $\zeta_q=\zeta(u_q)$ (оба — линейны по $1/\sigma$);
   * ${}_1F_1(\tfrac12;N;-x_q)$ **через** $e^{-x_q}\big[A_N\mathrm{erfcx}(\sqrt{x_q})+x_q^{\frac12-N}P_{N-1}(x_q)\big]$, с переключением на **ряд Маклорена** при малых $x_q$;
   * $\widetilde I_\nu(\zeta_q)$ — по кусочной схеме;
   * $\mathcal{I}_{\text{tail}}(u_q)$ — как в (4).
3. Свертка по узлам: $\text{Tail}=\sum_q w_q\,\mathcal{I}_{\text{tail}}(u_q)$.
4. Добавить оценку остатка $R(U_\star)$ из п.5 к бюджету погрешности.

Все шаги — батчно-векторные (формы $[B,M,Q]$), **без Python-циклов** в горячем пути.

## 7) Приёмочные критерии (локально для этого блока)

* **Корректность 1F1-блока**:
  $y(0)=1$; асимптотика $y\,e^{x}\,x^{N-\frac12}\to \Gamma(N)/\sqrt{\pi}$; отсутствие NaN/Inf при $N\le 1024$ на сетках $x\ge0$.
* **Стабильность углового блока**:
  $\widetilde I_\nu$ конечен и гладок на всей сетке; выбор ветви (ряд/Чебышёв/асимптотика) не даёт разрывов на стыках.
* **Обрезание**:
  $\big|\sum_q w_q\,\mathcal{I}_{\text{tail}}(u_q) + R(U_\star)- \int_0^\infty\mathcal{I}_{\text{tail}}\big|\le \varepsilon$ (референс — высокая точность).
* **Ресурсы**:
  пик-память $\mathcal{O}(|x|)$ (без материализации по $N$); время $\mathcal{O}(B\,M\,Q)$.

## 8) Замечания

* Замена 1F1 на $\mathrm{erfcx}+$полином — **эквивалентная** (строгое тождество для целых $N$); «оригинальная 1F1» не требуется.
* Модифицированный Бессель $I_\nu$ — часть канона углового усреднения; его «замена» — только в смысле **вычислительной формы** (скейлинг + кусочная стабильная аппроксимация), а не смены семейства функций.
* Линейность по $1/\sigma$ используется дважды: (i) **узость** диапазона аргументов $x=\kappa u$ и $\zeta(u)$, (ii) усиленная компенсация при вычитании нулевого фрейма, что уменьшает $U_\star$ и $Q$.

---

### Мини-интерфейс (для привязки к коду)

* `hyp1f1`: `_t_omega_1f1_half_neg_x(x, N, A_N, P_coeffs, small_x_switch, small_series_terms)` — точная форма 1F1 без спецфункции.
* `poly`: `_t_omega_poly(x, coeffs)` — векторная оценка $P_{N-1}(x)$ без циклов.
* `bessel`: скейленный (\widetilde I_\nu(\zeta)` с кусочной реализацией (ряд/Чебышёв/асимптотика) — единый хелпер.
* «Хвост»: радиальная GL на $[0,U_\star]$ + явный остаток $R(U_\star)$.

Эта модификация делает QTail **численно устойчивым** при больших $N$ и больших батчах, сохраняет **строгость** вывода (никаких сумм по решёткам/оболочкам) и опирается на уже **известный нулевой фрейм** для вычисления «остатка», что резко сокращает трудоёмкость интегрирования.
