# Алгоритм: **T_PD_MF_QTail** (DRAFT)

T-field, Poisson-Dual, Matrx-Free, Quatrature-Tail.

---

## 1. Данные и обозначения

* Размерность: $D=2N$.
* Точка замера: $z\in\mathbb C^N$ (эквивалентно $x\in\mathbb R^D$).
* Источник $j$: $(z_j,\ d_j,\ \sigma_{\parallel,j},\ \sigma_{\perp,j},\ \alpha_j,\ T_{\hat j})$.
* Единичное направление: $u_j := d_j/\|d_j\|$.
* Сдвиг в позиции: $x := z_j - z\in\mathbb R^D$, радиус $r := \|x\|$, продольная проекция $c := \langle x,u_j\rangle$.
* Параметры анизотропии (реальное пространство, **без матриц**):

  $$
  a := \sigma_{\perp,j}^{-2},\qquad b := \sigma_{\parallel,j}^{-2}-\sigma_{\perp,j}^{-2}.
  $$
* Ранг-1 метрика: $G := aI + b\,u_j u_j^\top$.
* Число $\nu := \frac{D}{2}-1$. Площадь единичной сферы: $C_D := \dfrac{2\pi^{D/2}}{\Gamma(D/2)}$.

---

## 2. Позиционный «текущий фрейм» $n=0$ (точно, без матриц)

Записываем **без поворотов** через норму и проекцию:

$$
A_{\text{pos}}(z) \;=\; \exp\!\Big(-\pi\Big[\tfrac{|c|^2}{\sigma_{\parallel,j}^2}
+\tfrac{r^2-|c|^2}{\sigma_{\perp,j}^2}\Big]\Big)
\;=\; \exp\!\big(-\pi\,x^\top G\,x\big).
$$

Это — точный вклад «текущего» периодического образа $n=0$.

---

## 3. Реальная периодизация: разложение «$n=0$ + хвост»

Полная периодическая сумма в реальном пространстве:

$$
\Theta^{(\mathrm{pos})}(x)
=\underbrace{e^{-\pi\,x^\top G x}}_{n=0}
+\underbrace{\sum_{n\in\mathbb Z^D\setminus\{0\}} e^{-\pi\,(x+n)^\top G (x+n)}}_{\Theta^{\mathrm{tail}}_{\mathrm{real}}(x)}.
$$

Мы считаем её как

$$
\Theta^{(\mathrm{pos})}(x)= A_{\text{pos}}(z)\,\Big[\,1 + \mathcal T(x)\,\Big],
$$

где «хвостовое отношение»

$$
\mathcal T(x)
=\sum_{n\in\mathbb Z^D\setminus\{0\}}
\exp\!\Big(-\pi\,n^\top G n\Big)\;
\exp\!\Big(-2\pi\,x^\top G n\Big).
$$

---

## 4. Квадратурная аппроксимация хвоста $\mathcal T(x)$

Идея: заменить дискретный хвост **сферически усреднённым интегралом по радиусу** и взять его **1D-квадратурой Гаусса–Лагерра**. Всё — без матриц, только нормы и проекции.

### 4.1. Подготовка к угловому усреднению

Для каждого радиуса $\rho=\|n\|$ положим:

$$
n^\top G n = a\,\rho^2 + b\,\rho^2\cos^2\theta,\qquad
x^\top G n = \underbrace{a\,x + b\,c\,u_j}_{=:v}\ \cdot\ n,
$$

где $\cos\theta=\frac{\langle n,u_j\rangle}{\rho}$, $c=\langle x,u_j\rangle$, а

$$
v \;=\; a\,x + b\,c\,u_j,\qquad m:=\|v\|.
$$

Тогда

$$
\exp\!\big(-2\pi\,x^\top G n\big)=\exp\!\big(-2\pi\,m\,\rho\ \cos\phi\big),
$$

где $\phi$ — угол между $v$ и $n$.

### 4.2. Два угловых усреднения (по сфере $S^{D-1}$)

1. Квадратичный анизотропный множитель:

$$
\Big\langle e^{-\pi\,b\,\rho^2\cos^2\theta}\Big\rangle_{\text{угол}}
=\;{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};\,-\pi b\,\rho^2\Big).
$$

2. Линейный (радиальный) множитель (известная сферическая формула):

$$
\Big\langle e^{-2\pi\,m\,\rho\,\cos\phi}\Big\rangle_{\text{угол}}
=\Gamma\!\Big(\tfrac{D}{2}\Big)\,\Big(\tfrac{2}{2\pi m\rho}\Big)^{\!\nu}\!
I_{\nu}(2\pi m\rho),
$$

где $I_\nu$ — модифицированная функция Бесселя первого рода.

**Аппроксимация хвоста усреднением.** Заменяя суммирование по узлам решётки на сферически усреднённую «плотность» по радиусу, получаем:

$$
\mathcal T(x)\ \approx\ C_D \int_{0}^{\infty}
\rho^{D-1}\;e^{-\pi a\,\rho^2}\;
{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};\,-\pi b\,\rho^2\Big)\;
\Gamma\!\Big(\tfrac{D}{2}\Big)\Big(\tfrac{2}{2\pi m\rho}\Big)^{\!\nu}
I_{\nu}(2\pi m\rho)\;d\rho.
$$

### 4.3. Приведение к форме Лагерра (1D-квадратура)

Сделаем замену

$$
u \;=\; \pi a\,\rho^2\quad\Longrightarrow\quad
\rho=\sqrt{\tfrac{u}{\pi a}},\ \ \ d\rho=\frac{du}{2\sqrt{\pi a\,u}}.
$$

Тогда

$$
\rho^{D-1}d\rho
=\frac{1}{2}(\pi a)^{-D/2}\,u^{\nu}\,du.
$$

Обозначим

$$
\kappa:=\frac{b}{a}\ (\text{безразмерная анизотропия}),\qquad
\zeta(u):=2\pi m\sqrt{\frac{u}{\pi a}}\;=\;2\sqrt{\pi}\,m\,a^{-1/2}\,u^{1/2}.
$$

Получаем **каноническую форму для Гаусса–Лагерра** (вес $u^{\nu}e^{-u}$):

$$
\boxed{\;
\mathcal T(x)\ \approx\ K_D(a)\!
\int_{0}^{\infty}\! u^{\nu}e^{-u}\;
\Phi_{Q}(u;\,m,a,\kappa)\,du\;},
$$

где

$$
K_D(a)\;=\;\frac{C_D}{2}\,(\pi a)^{-D/2}\,\Gamma\!\Big(\tfrac{D}{2}\Big)\,2^{\nu},\qquad
\Phi_{Q}(u;\,m,a,\kappa)\;=\;
{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};\,-\kappa\,u\Big)\;
\zeta(u)^{-\nu}\,I_{\nu}\!\big(\zeta(u)\big).
$$

**Квадратура Гаусса–Лагерра.** Пусть $\{(u_q,w_q^{(\nu)})\}_{q=1}^Q$ — узлы/веса GL с параметром $\alpha=\nu$. Тогда

$$
\boxed{\;
\mathcal T(x)\ \approx\ K_D(a)\,\sum_{q=1}^{Q} w_q^{(\nu)}\;\Phi_{Q}\!\big(u_q;\,m,a,\kappa\big)\; }.
$$

Итого позиционная периодизация:

$$
\boxed{\;\Theta^{(\mathrm{pos})}(x)\ \approx\ A_{\text{pos}}(z)\,\Big[1+K_D(a)\sum_{q=1}^{Q} w_q^{(\nu)}\,\Phi_{Q}(u_q;\,m,a,\kappa)\Big].\;}
$$

Все величины $m,a,\kappa$ выражены через **нормы и проекции**:

$$
m \;=\; \big\|a\,x + b\,c\,u_j\big\|,
\quad a=\sigma_{\perp}^{-2},
\quad b=\sigma_{\parallel}^{-2}-\sigma_{\perp}^{-2},
\quad \kappa=\frac{b}{a}.
$$

---

## 5. Направленческий множитель (домножается один раз)

Определён в каноне как

$$
A_{\mathrm{dir},j}\;=\;\mathcal A\!\big(\mathrm{delta_vec_d}(d,\ d_j)\big),
$$

и **не периодизуется**. Домножается один раз к позиционной части.

---

## 6. Вклад источника и итоговое поле

Для источника $j$ в точке $z$:

$$
\mathrm{contrib}_j(z)
\;=\;\alpha_j\;\Big(T_{\hat j}\cdot \Theta^{(\mathrm{pos})}(z_j{-}z)\Big)\;\cdot A_{\mathrm{dir},j}.
$$

Поле:

$$
T(z,\cdot)\;=\;\sum_{j=1}^{M}\mathrm{contrib}_j(z)
\quad\text{(при необходимости берём }\Re\{\cdot\}\text{ на финальном шаге).}
$$

---

## 7. Почему это должно работать (строгие аргументы и аппроксимационные факты)

1. **Точный «текущий фрейм».** Член $n=0$ $=\ e^{-\pi x^\top G x}$ вычисляется **строго** и без матриц через одну норму и одну проекцию; это эквивалентно «повороту+диагонали».

2. **Строгая декомпозиция реальной периодизации.** Представление

$$
\Theta^{(\mathrm{pos})}(x)=e^{-\pi x^\top G x}+\sum_{n\neq 0}e^{-\pi(x+n)^\top G(x+n)}
$$

тождественно. Мы аппроксимируем **только хвост**.

3. **Сферическое усреднение хвоста.** На больших $\rho$ вклад узлов решётки с нормой $\rho$ близок к вкладy «сферической оболочки» радиуса $\rho$. Для гауссового ядра погрешность замены «сумма по узлам оболочки» $\to$ «сферическое усреднение» убывает быстрее любой степени по $\rho$ (экспоненциально за счёт $e^{-\pi a\rho^2}$).

4. **Угловые интегралы — замкнутые формы.**

   * Квадратичный анизотропный множитель даёт ${}_1F_1(\tfrac12;\tfrac D2;-\pi b\rho^2)$.
   * Линейный множитель $e^{-2\pi v\cdot n}$ даёт модифицированный Бессель $I_\nu(2\pi m\rho)$ с $\nu=\tfrac{D}{2}-1$. Эти формулы — классические сферические средние.

5. **Редукция к 1D-квадратуре.** Замена $u=\pi a\rho^2$ приводит интеграл к стандартной форме Гаусса–Лагерра (вес $u^{\nu}e^{-u}$), что обеспечивает **суперлинейную** сходимость по числу узлов $Q$.

6. **Матрицы не нужны.** Все скаляры $a,b,\kappa,m$ считаются из $\sigma_{\parallel,\perp}$, $x$, $u_j$ через нормы и проекции. Ни $D\times D$ объектов, ни решёток оффсетов в памяти.

**Итог:** алгоритм даёт контролируемую ε-точность за счёт (i) экспоненциальной малости хвоста и (ii) суперлинейной сходимости 1D-квадратуры. Точный текущий фрейм складывается с интегральной оценкой хвоста, полученной строгим сферическим усреднением и редукцией к одномерной GL-квадратуре.

---

## 8. Краткий чек-лист реализации (строго по шагам)

1. Входные данные $\to$ $u_j,\,x,\,r,\,c$.
2. Константы: $a=\sigma_{\perp}^{-2},\ b=\sigma_{\parallel}^{-2}-\sigma_{\perp}^{-2},\ \nu=D/2-1,\ C_D$.
3. **Точный** $A_{\text{pos}}=\exp\!\big(-\pi[|c|^2/\sigma_{\parallel}^2+(r^2-|c|^2)/\sigma_{\perp}^2]\big)$.
4. $v=a x + b c u_j$, $m=\|v\|$.
5. Подготовить узлы/веса GL $\{(u_q,w_q^{(\nu)})\}_{q=1}^Q$.
6. Вычислить

   $$
   S:=K_D(a)\sum_{q=1}^{Q} w_q^{(\nu)}\;{}_1F_1\!\Big(\tfrac12;\tfrac{D}{2};-\kappa\,u_q\Big)\;
   \zeta(u_q)^{-\nu}\,I_\nu\!\big(\zeta(u_q)\big),
   $$

   где $\kappa=b/a$, $\zeta(u)=2\sqrt{\pi}\,m\,a^{-1/2}\,u^{1/2}$, $K_D(a)=\dfrac{C_D}{2}(\pi a)^{-D/2}\Gamma(\tfrac{D}{2})\,2^{\nu}$.
7. $\Theta^{(\mathrm{pos})}\approx A_{\text{pos}}\,(1+S)$.
8. Домножить $A_{\mathrm{dir},j}=\mathcal A(\mathrm{delta_vec_d}(d,d_j))$ **один раз** и собрать вклад $\mathrm{contrib}_j=\alpha_j\,(T_{\hat j}\cdot \Theta^{(\mathrm{pos})})\cdot A_{\mathrm{dir},j}$.
9. Просуммировать по $j$.

Это и есть **T_PD_MF_QTail**: «текущий фрейм» точно, хвост — одной 1D-квадратурой, никаких матриц и решёток, строгое разложение в реальном пространстве и аналитическое угловое усреднение для хвоста.
