# CPSF — редукция онлайнового шага к одному матричному умножению

**Статус:** строгий документ (теория + алгоритм).  
**Цель:** показать, что при известном наборе вкладов ${C_j}_{j=1}^M$ вычисление поля CPSF в произвольном запросе $(z,\,\vec d)$ можно свести к **одному** матричному умножению $T = Z\,\phi(z,\vec d)$ после оффлайн‑предрасчёта матриц $Y$ и $Z=X^\top Y$.  
**Соблюдение канона:** используем только уже зафиксированные в CPSF обозначения и структуру вклада:  
$C_j = (z_j,\,\vec d_j,\,\hat T_j,\,\sigma_{\parallel j},\,\sigma_{\perp j},\,\alpha_j)$.  
Размерности: $z\in\mathbb C^N$ (периодизация по вещественной части), $\hat T_j\in\mathbb C^{S}$. Число вкладов — $M$.

---

## 1. Фиксация обозначений (без введения новых объектов)

- Вес одного вклада в запросе $(z,\vec d)$:
  $$
  w_j(z,\vec d) := \alpha_j\,\mathrm{Re}\,\eta_j(z,\vec d),
  $$
  где $\eta_j$ — каноническое CPSF‑ядро вклада $C_j$, факторизуемое на позиционный и направленческий множители (позиционный — торически периодичен; направленческий — **без** периодизации).

- Поле:
  $$
  T(z,\vec d)\;=\;\sum\limits_{j=1}^{M} w_j(z,\vec d)\,\hat T_j\;=\; w(z,\vec d)^\top X,\quad
  X[j,k] \equiv \hat T_j[k],\quad X\in\mathbb C^{M\times S}.
  $$

- Вектор признаков запроса (база функций от $(z,\vec d)$):
  $\phi(z,\vec d)\in\mathbb R^{F}$. Конкретика выбора базы задаётся ниже (фурье по тору $z$ × ортонормированная система по $\vec d$).

- Оффлайн‑матрица коэффициентов весов: $Y\in\mathbb R^{M\times F}$, такая что
  $$
  w(z,\vec d)=Y\,\phi(z,\vec d).\tag{1}
  $$

- Матрица онлайнового шага: $Z := X^\top Y\in\mathbb C^{S\times F}$.

**Цель:** доказать существование (1) с явной конструкцией $Y$ и вывести
$$
T(z,\vec d) = Z\,\phi(z,\vec d),\quad \text{т.е. онлайн — одно матричное умножение.}\tag{2}
$$

---

## 2. Предпосылки (условия применимости)

**(A1) Позиционная часть ядра.** Для каждого $j$ позиционный множитель $\eta^{\mathrm{pos}}_j(z)$ — гладкая $\mathcal C^{\infty}$ торически периодическая функция по вещественной части $z$ и допускает абсолютно сходящийся фурье‑ряд на $\mathbb T^{2N}$ (гауссово/квазингауссово затухание коэффициентов).

**(A2) Направленческая часть ядра.** Для каждого $j$ направленческий множитель $\eta^{\mathrm{dir}}_j(\vec d)$ — гладкая квадратно‑интегрируемая функция на собственной области направления (зафиксированной каноном; периодизации по направлению **нет**).

**(A3) Ограниченность параметров.** $\alpha_j,\ z_j,\ \vec d_j,\ \sigma_{\parallel j},\ \sigma_{\perp j},\ \hat T_j$ конечны и равномерно ограничены по $j$.

Эти условия совпадают с теми, что используются в каноне при выводе пуассоновской (дуальной) формы позиционного блока и гладкости направленческого блока.

---

## 3. База признаков запроса $\phi$ (конструкция без изменения канона)

### 3.1. Позиционная часть (торическая фурье‑база)
Берём действительную фурье‑базу на $\mathbb T^{2N}$:
$$
\{\cos(2\pi\,k\!\cdot\! z),\; \sin(2\pi\,k\!\cdot\! z)\}_{k\in\mathbb Z^{2N}}.
$$
По (A1) для каждого $j$ существует разложение
$$
\eta^{\mathrm{pos}}_j(z)=\sum\limits_{k\in\mathbb Z^{2N}}\!\big(A_{j,k}\cos 2\pi k\!\cdot\! z + B_{j,k}\sin 2\pi k\!\cdot\! z\big),
$$
с абсолютной сходимостью и экспоненциальным спадом коэффициентов по $\|k\|$.

### 3.2. Направленческая часть (полная ОНС)
Пусть ${\varphi_\ell(\vec d)}_{\ell\in\mathbb N}$ — полная ортонормированная система на области направлений (в терминах канона — в координатах локальной рамки). По (A2)
$$
\eta^{\mathrm{dir}}_j(\vec d)=\sum\limits_{\ell=1}^{\infty} D_{j,\ell}\,\varphi_\ell(\vec d),\quad \sum_{\ell}|D_{j,\ell}|^2<\infty.
$$

### 3.3. Произведённая база запроса
Определим признаки (компоненты $\phi$) как произведения позиционных и направленческих баз:
$$
\phi_{(k,\cos),\ell}(z,\vec d)=\cos(2\pi k\!\cdot\! z)\,\varphi_\ell(\vec d),\qquad
\phi_{(k,\sin),\ell}(z,\vec d)=\sin(2\pi k\!\cdot\! z)\,\varphi_\ell(\vec d).
$$
Собираем их в вектор $\phi(z,\vec d)\in\mathbb R^{F}$ (счётная длина $F=\infty$).

---

## 4. Существование оффлайн‑матрицы $Y$ и точная линейная факторизация весов

### Лемма 1 (линейное разложение весов)
При условиях (A1)–(A3) для каждого $j$ существуют коэффициенты ${Y_{j,f}}_{f}$, зависящие **только** от параметров вкладов $C_j$, такие что
$$
w_j(z,\vec d)=\sum\limits_{f} Y_{j,f}\,\phi_f(z,\vec d).
$$

**Доказательство.** По определению $w_j=\alpha_j\,\mathrm{Re}\,\eta_j$ и факторизации $\eta_j=\eta^{\mathrm{pos}}_j\,\eta^{\mathrm{dir}}_j$, а также по разложениям из §3.1–3.2,
$$
\eta_j(z,\vec d)
= \Big(\sum_{k} A_{j,k}\cos(2\pi k\!\cdot\! z)+B_{j,k}\sin(2\pi k\!\cdot\! z)\Big)
  \Big(\sum_{\ell} D_{j,\ell}\,\varphi_\ell(\vec d)\Big).
$$
Произведение рядов сходится абсолютно по $k$ и квадратично по $\ell$; в силу абсолютной сходимости по $k$ допустимы перестановка и группировка слагаемых (Тонелли/Фубини). Тогда
$$
\eta_j=\sum_{k,\ell}\Big(A_{j,k}D_{j,\ell}\,\cos(2\pi k\!\cdot\! z)\,\varphi_\ell(\vec d)
\; +\;B_{j,k}D_{j,\ell}\,\sin(2\pi k\!\cdot\! z)\,\varphi_\ell(\vec d)\Big),
$$
и, применяя $\alpha_j\mathrm{Re}(\cdot)$ покомпонентно, получаем требуемую линейную комбинацию по компонентам $\phi$ с коэффициентами
$Y_{j,(k,\cos),\ell}=\alpha_j\,\mathrm{Re}(A_{j,k}D_{j,\ell})$,
$Y_{j,(k,\sin),\ell}=\alpha_j\,\mathrm{Re}(B_{j,k}D_{j,\ell})$.
$\square$

### Следствие 1 (матричная форма весов)
Обозначая $Y\in\mathbb R^{M\times F}$ матрицу из строк $Y_{j,:}$ и $\phi$ как столбец признаков, получаем **ровно** (1):
$$
w(z,\vec d)=Y\,\phi(z,\vec d).
$$

---

## 5. Главный результат: редукция к одному матричному умножению

### Теорема 1 (точная редукция при полной базе)
При условиях (A1)–(A3) и с определениями §1–§4 для любого запроса $(z,\vec d)$ верно тождество
$$
T(z,\vec d)\;=\;Z\,\phi(z,\vec d),\quad Z:=X^\top Y\in\mathbb C^{S\times F}.
$$

**Доказательство.** По канону $T=\sum_j w_j\hat T_j = w^\top X$. По Следствию 1, $w=Y\,\phi$. Следовательно, $T=(Y\,\phi)^\top X = (X^\top Y)\,\phi = Z\,\phi$. Все перестановки допустимы, так как здесь конечная сумма по $j$ и матричные умножения правильно размерены. $\square$

**Интерпретация.** Все зависимости от вкладов ${C_j}$ «впитаны» в матрицу $Z$. Онлайновый шаг: построить $\phi(z,\vec d)$ и выполнить **одно** умножение матрицы на вектор.

---

## 6. Практическая (конечномерная) версия с контролем ошибки

### 6.1. Усечение базы
Выбираем конечные подмножества мод $K\subset\mathbb Z^{2N}$ и направленческих индексов $L\subset\mathbb N$. Формируем конечный набор признаков
$\phi(z,\vec d)\in\mathbb R^{F}$ с $F=2|K|\cdot |L|$,
усекаем ряды в §3.1–3.2 и определяем усечённые $Y$ и $Z=X^\top Y$.

### Теорема 2 ($\varepsilon$-точность)
Для любого $\varepsilon>0$ существуют $K$ и $L$ такие, что
$$
\sup_{(z,\vec d)} \big\|T(z,\vec d) - Z\,\phi(z,\vec d)\big\|_{\mathbb C^S}\ \le\ \varepsilon.
$$

**Эскиз доказательства.** Позиционный хвост фурье‑суммы при гауссовом затухании ограничивается как $\lesssim \exp(-c\,\|k\|^2)$ при $\|k\|\to\infty$ с константой $c>0$, зависящей от нижних границ $\sigma_{\parallel j},\sigma_{\perp j}$. Направленческий хвост контролируется стандартными оценками выбранной ОНС (парсеваль/бессель). Выбирая радиус по $k$ и число направленческих функций $|L|$, добиваемся любого $\varepsilon$. Линейность сборки в $X$ переносит эти оценки на $T$. $\square$

---

## 7. Конструкция $Y$ (оффлайн) и формула $Z$

Для каждого вклада $j$:
1) Вычислить фурье‑коэффициенты позиционного блока $A_{j,k}, B_{j,k}$ для всех $k\in K$ (закрытые формулы через пуассоновскую форму ядра; коэффициенты зависят от $z_j,\sigma_{\parallel j},\sigma_{\perp j},\ldots$).
2) Разложить направленческий множитель по ${\varphi_\ell}_{\ell\in L}$: получить $D_{j,\ell}$.
3) Сформировать строку $Y_{j,:}$ по правилам Леммы 1 (с учётом $\alpha_j$ и операции $\mathrm{Re}$).

После построения всех строк:  
**собрать**
$$
Z \;=\; X^\top Y \;=\; \sum_{j=1}^{M} \hat T_j\,Y_{j,:}^\top.
$$
Это ранговая композиция: можно добавлять/удалять вклады без пересчёта с нуля.

---

## 8. Алгоритм (оффлайн → онлайн)

### Оффлайн (однократно для данного множества вкладов)
1) Выбрать конечные $K,L$ под заданную точность $\varepsilon$.  
2) Для каждого $j$ построить $Y_{j,:}$.  
3) Вычислить $Z=X^\top Y$ ранговой суммой.

**Обновление:** при добавлении $C_{m+1}$: $Z \leftarrow Z + \hat T_{m+1}\,Y_{m+1,:}^\top$. При удалении/изменении — аналогично.

### Онлайн (любой запрос)
1) Вычислить $\phi(z,\vec d)$ (кос/син для $k\in K$, $\varphi_\ell(\vec d)$ для $\ell\in L$).  
2) Вернуть $T=Z\,\phi(z,\vec d)$.  
**Гарантия:** при полной базе — равенство; при конечной — $\varepsilon$-точность.

---

## 9. Численная устойчивость и сложность

- **Стабильность.** Фурье‑коэффициенты позиционной части убывают экспоненциально по $\|k\|$; направленческие коэффициенты — как у выбранной ОНС. Это обеспечивает хорошую обусловленность при разумном $F$.
- **Сложность онлайн.** Одна GEMV: $\mathcal O(SF)$. Вычисление $\phi$: $\mathcal O(F)$.  
- **Память.** Хранение $Z\in\mathbb C^{S\times F}$. Выбор $F$ балансирует точность и VRAM/ОЗУ.

---

## 10. Валидация и калибровка $K,L$

- Сходимость по $K$: мониторинг нормы $\|T_{K,L}-T_{K',L}\|$ при увеличении радиуса по $k$.  
- Сходимость по $L$: мониторинг хвоста по $\ell$.  
- Целевой критерий: минимальный $F$ при заданной $\varepsilon$ на тест‑сете запросов.

---

## 11. Границы применимости

- Теорема 1 — точная при **полной** (неусечённой) базе признаков $\phi$.  
- Теорема 2 — практическая $\varepsilon$-редукция при конечной базе.  
- Никаких изменений канона CPSF не требуется: все конструкции — переупаковка уже существующих формул (позиционная фурье‑сумма × направленческая гладкая часть), с оффлайн‑сборкой коэффициентов в $Y$ и последующим $Z=X^\top Y$.

---

## 12. Краткий глоссарий (ровно в используемых обозначениях)

- $C_j=(z_j,\vec d_j,\hat T_j,\sigma_{\parallel j},\sigma_{\perp j},\alpha_j)$ — вклад.  
- $w_j(z,\vec d)=\alpha_j\,\mathrm{Re}\,\eta_j(z,\vec d)$ — вес вклада в запрос.  
- $X[j,k]\equiv \hat T_j[k]\in\mathbb C^{M\times S}$.  
- $\phi(z,\vec d)\in\mathbb R^{F}$ — признаки запроса (фурье по $z$ × ОНС по $\vec d$).  
- $Y\in\mathbb R^{M\times F}$ — оффлайн‑коэффициенты весов: $w=Y\phi$.  
- $Z=X^\top Y\in\mathbb C^{S\times F}$ — матрица онлайнового шага.  
- Онлайн: $T=Z\,\phi(z,\vec d)$ — одно умножение.

---

### Итог
Вся «сложность решёток и сумм» переносится в оффлайн‑этап (расчёт $Y$ и $Z$). Онлайновое вычисление поля CPSF в произвольном запросе $(z,\vec d)$ сводится к **одной** операции матричного умножения $T=Z\,\phi(z,\vec d)$; при полной базе — строго, при конечной — с контролируемой погрешностью $\varepsilon$.

