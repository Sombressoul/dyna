# CPSF — редукция онлайнового шага к одному матричному умножению — T_PD_MF_QTail версия алгоритма

$$
\eta_j(z,\vec d)
=\underbrace{e^{-\pi\,\delta\vec d^\dagger A^{(\mathrm{dir})}_j\,\delta\vec d}}_{C^{(\mathrm{dir})}_j}\cdot
\underbrace{\Theta^{(\mathrm{pos})}_j(\delta z)}_{\text{позиционная периодизация}},
\quad
T(z,\vec d)=\sum_j\big(\alpha_j\,\mathrm{Re}\,\eta_j(z,\vec d)\big)\,\hat T_j,
$$

где $\Theta^{(\mathrm{pos})}_j$ равносильна реальной сумме по $n\in\mathbb Z^{2N}$ и дуальной по $k\in\mathbb Z^{2N}$; направленческий множитель не периодизуется (A.2–A.9).
Далее — «по-взрослому»: пред-расчёт, хранимые данные, онлайн-шаг и инкрементальное добавление вклада **в формализме T_PD_MF_QTail** (без решёточных сумм по $k$; хвост периодизации — 1D-квадратурой). 

# 1. Канон и разложение «$n=0$+хвост» (реальное пространство)

Для источника $j$ пусть $D=2N$, $x:=z_j-z\in\mathbb R^D$, $u_j:=d_j/\|d_j\|$, $r=\|x\|$, $c=\langle x,u_j\rangle$. Вводим скаляры

$$
a:=\sigma_{\perp,j}^{-2},\qquad b:=\sigma_{\parallel,j}^{-2}-\sigma_{\perp,j}^{-2},\qquad
G:=aI+b\,u_ju_j^\top,\qquad \nu:=\tfrac{D}{2}-1,\ C_D=\frac{2\pi^{D/2}}{\Gamma(D/2)}.
$$

Точный «текущий» кадр $n=0$:

$$
A_{\mathrm{pos}}(z)=\exp\!\big(-\pi\,x^\top G x\big)
=\exp\!\Big(-\pi\Big[\tfrac{|c|^2}{\sigma_{\parallel,j}^2}+\tfrac{r^2-|c|^2}{\sigma_{\perp,j}^2}\Big]\Big).
$$

Позиционная периодизация:

$$
\Theta^{(\mathrm{pos})}(x)=A_{\mathrm{pos}}(z)\big[1+\mathcal T(x)\big],\quad
\mathcal T(x)=\sum_{n\in\mathbb Z^D\setminus\{0\}}\!e^{-\pi\,n^\top Gn}\,e^{-2\pi\,x^\top Gn}.
$$

Это тождественно эквивалентно канону (A.5) при $t=1$.

# 2. Строгое угловое усреднение хвоста и редукция к 1D-квадратуре

Положим $\rho=\|n\|$, $\cos\theta=\langle n,u_j\rangle/\rho$, $v:=a x + b c\,u_j$, $m:=\|v\|$. Тогда

$$
n^\top G n=a\rho^2+b\rho^2\cos^2\theta,\qquad x^\top Gn=v\cdot n,
$$

и, усредняя по сфере $S^{D-1}$, получаем классические формулы:

$$
\Big\langle e^{-\pi b\rho^2\cos^2\theta}\Big\rangle
={}_1F_1\!\Big(\tfrac12;\tfrac D2;-\pi b\rho^2\Big),\qquad
\Big\langle e^{-2\pi m\rho\cos\phi}\Big\rangle
=\Gamma\!\Big(\tfrac D2\Big)\Big(\tfrac{2}{2\pi m\rho}\Big)^{\!\nu}\! I_\nu(2\pi m\rho).
$$

Заменой $u=\pi a\rho^2$ приводим радиальный интеграл к форме Гаусса–Лагерра (вес $u^{\nu}e^{-u}$):

$$
\mathcal T(x)\ \approx\ K_D(a)\int_0^\infty u^{\nu}e^{-u}\,\Phi(u;m,a,\kappa)\,du,
$$

$$
K_D(a)=\frac{C_D}{2}(\pi a)^{-D/2}\Gamma\!\Big(\tfrac D2\Big)\,2^{\nu},\quad
\kappa=\frac{b}{a},\quad \zeta(u)=2\sqrt{\pi}\,m\,a^{-1/2}\,u^{1/2},
$$

$$
\Phi(u;m,a,\kappa)={}_1F_1\!\Big(\tfrac12;\tfrac D2;-\kappa u\Big)\,\zeta(u)^{-\nu}I_\nu(\zeta(u)).
$$

Правило квадратуры Гаусса–Лагерра с параметром $\alpha=\nu$ (узлы/веса $\{(u_q,w_q^{(\nu)})\}_{q=1}^Q$) даёт

$$
\boxed{\ \Theta^{(\mathrm{pos})}(x)\ \approx\ A_{\mathrm{pos}}(z)\Big[1+K_D(a)\sum_{q=1}^Q w_q^{(\nu)}\,\Phi(u_q;m,a,\kappa)\Big].\ }
$$

Все величины $m,a,\kappa$ выражаются через **нормы и проекции** (без матриц).

# 3. Оффлайн-предрасчёт (строго по шагам)

Фиксируем $D=2N\Rightarrow\nu=\tfrac D2-1$ и порядок GL-квадратуры $Q$ под требуемую точность $\varepsilon$.

**(O1) Узлы и веса.** Разово для данной $\nu$: $\{(u_q,w_q^{(\nu)})\}_{q=1}^Q$. Храним массивы $u\in\mathbb R^Q,\ w\in\mathbb R^Q$. 

**(O2) Пер-вкладовые константы.** Для каждого $j$: $a_j,b_j,\kappa_j=b_j/a_j,\ C_D,\ K_D(a_j)$. Хранить скаляры. 

**(O3) Пер-вкладовая «ширина хвоста».** Предвычислить матрицу

$$
\boxed{\ H_{j,q}\ :=\ K_D(a_j)\,w_q^{(\nu)}\;
{}_1F_1\!\Big(\tfrac12;\tfrac D2;-\kappa_j u_q\Big)\ \in\ \mathbb R^{M\times Q}. \ }
$$

Это единственный «тяжёлый» спец-функциональный шаг оффлайн; он **не зависит** от запроса $(z,\vec d)$. Хранить $H$ (float, $M\times Q$). 

**(O4) Данные канона.** Направленческие рамки/параметры для $C^{(\mathrm{dir})}_j$ (как в A.7–A.8), $\alpha_j$, $\hat T_j$. Храним $\{\alpha_j,\hat T_j\}$ и (при желании) $R(d_j)$ для ускорения онлайна; сам направленческий множитель зависит от $\delta\vec d$ и считается онлайн.

**Хранимые данные (итог):** $u,w$ (размер $Q$), пер-вкладовые скаляры $(a_j,b_j,\kappa_j,K_D(a_j))$, матрица $H\in\mathbb R^{M\times Q}$, а также $\{\alpha_j,\hat T_j\}$ (и опционально предвычисленные рамки). Никаких $K$-мод, никаких больших матриц $Y$ или $Z$. 

# 4. Онлайн-вычисление поля (один запрос)

Для каждого $j$ при заданных $(z,\vec d)$:

**(E1)** Геометрия в позиции: $x=z_j-z$, $c=\langle x,u_j\rangle$, $v=a_j x + b_j c\,u_j$, $m_j=\|v\|$, $A_{\mathrm{pos},j}=e^{-\pi x^\top G_j x}$. 

**(E2)** Вектор «бесселевских» факторов длины $Q$:

$$
\psi_j(q)\ :=\ \zeta_j(u_q)^{-\nu}\,I_\nu\!\big(\zeta_j(u_q)\big),\qquad
\zeta_j(u)=2\sqrt{\pi}\,m_j\,a_j^{-1/2}\,u^{1/2}.
$$

**(E3)** Скаляр хвоста: $S_j(z)=\sum_{q=1}^Q H_{j,q}\,\psi_j(q)$.

**(E4)** Позиционный множитель: $\Theta^{(\mathrm{pos})}_j(z)\approx A_{\mathrm{pos},j}(1+S_j(z))$.

**(E5)** Направленческий множитель: $C^{(\mathrm{dir})}_j(\delta\vec d)$ (закрытая экспонента, без решётки; см. A.7). Итоговый вес:

$$
w_j(z,\vec d)=\alpha_j\,\mathrm{Re}\!\Big(C^{(\mathrm{dir})}_j(\delta\vec d)\cdot \Theta^{(\mathrm{pos})}_j(z)\Big).
$$

**(E6)** Поле: $T(z,\vec d)=\sum_j w_j(z,\vec d)\,\hat T_j$.

**Сложность онлайна:** $O(MQ)$ вызовов $I_\nu$+$O(MQ)$ умножений и $O(MS)$ линейных комбинаций с $\hat T_j$. Память на запрос — $O(Q)+O(S)$. Никаких $k$-решёток. 

# 5. Инкрементальное добавление нового вклада

Добавляется новый $C_{m+1}$. Оффлайн-стоимость — **только одна строка** $H_{m+1,:}$:

$$
H_{m+1,q}=K_D(a_{m+1})\,w_q^{(\nu)}\;
{}_1F_1\!\Big(\tfrac12;\tfrac D2;-\kappa_{m+1} u_q\Big)\quad (q=1,\dots,Q),
$$

и сохранение $\alpha_{m+1},\hat T_{m+1}$ (и, опционально, рамок). Онлайн-ядро (E1)–(E6) автоматически учитывает вклад через ту же формулу. Никаких пересборок глобальных матриц не требуется. 

# 6. Корректность и аппроксимационные оценки

**Лемма 1 (точность «текущего кадра»).** Член $n=0$ равен $A_{\mathrm{pos}}(z)=e^{-\pi x^\top Gx}$ при любом $D$.
*Доказательство.* Это прямое вынесение члена $n=0$ из реальной суммы (A.5) и эквивалентная запись квадратичной формы без поворотов, через $a,b,u_j$.

**Лемма 2 (сферические средние).** Для $D=2N$, $\nu=D/2-1$ справедливы равенства угловых средних из §2, а значит замена сумм по узлам на сферически усреднённую «плотность оболочек» корректно захватывает радиальную структуру хвоста.
*Доказательство.* Это классические формулы для средних экспонент квадратика и линейной формы (см. выписанные выражения с ${}_1F_1$ и $I_\nu$); применяются к анизотропной Гауссиане в ранге-1 деформации $G$. 

**Лемма 3 (редукция к GL и устойчивость).** Подстановкой $u=\pi a\rho^2$ получаем интеграл вида $\int_0^\infty u^{\nu}e^{-u}\Phi(u)\,du$, где $\Phi(u)$ — произведение ${}_1F_1(\cdot;-\kappa u)$ и $\zeta(u)^{-\nu}I_\nu(\zeta(u))$, обе — аналитические по $u\ge0$. Применение квадратуры Гаусса–Лагерра порядка $Q$ даёт аппроксимацию $\mathcal T_Q(x)$ со **суперлинейной** сходимостью по $Q$.

**Теорема 1 (ε-аппроксимация позиции).** Для любого $\varepsilon>0$ существует $Q$ такое, что

$$
\sup_{x}\big|\Theta^{(\mathrm{pos})}(x)-A_{\mathrm{pos}}(z)\,[1+\mathcal T_Q(x)]\big|\le \varepsilon.
$$

*Доказательство (эскиз).* Экспоненциальный множитель $e^{-\pi a\rho^2}$ обеспечивает сверхбыстрое затухание хвоста, а аналитичность $\Phi$ даёт экспоненциально-малую дискретизационную ошибку GL при росте $Q$. Суммарная погрешность контролируется константами $a,b,D$. 

**Теорема 2 (линейность и композиционность).** При фиксированных $\{(u_q,w_q^{(\nu)})\}$ и матрице $H$ веса $w_j(z,\vec d)$ имеют вид

$$
w_j(z,\vec d)=\alpha_j\,\mathrm{Re}\!\Big(C^{(\mathrm{dir})}_j(\delta\vec d)\,A_{\mathrm{pos},j}(z)\Big)\ +\ 
\alpha_j\,\mathrm{Re}\!\Big(C^{(\mathrm{dir})}_j(\delta\vec d)\,A_{\mathrm{pos},j}(z)\,(H_{j,:}\cdot\psi_j(z))\Big),
$$

и итоговое поле есть линейная комбинация $\sum_j w_j \hat T_j$. Добавление нового вклада линейно в $H_{j,:}$ (строка ранга-1 по отношению к $\hat T_j$). *Доказательство.* Прямое следствие формулы из §4 и канона (A.3). 

**Замечание о каноне.** Направленческий множитель $C^{(\mathrm{dir})}_j$ остаётся «как есть» (A.7): он не периодизуется и считается онлайн по $\delta\vec d$, как и в стандартных процедурах `T_PD_window`/`T_PD_full`.

# 7. Что именно упрощается (vs. решётка по $k$)

* **Нет параметра $K$ и окон по $k$.** Хвост периодизации — **1D**-квадратура на $[0,\infty)$ порядка $Q$. 
* **Нет больших матриц $Y,Z$.** Оффлайн-память: только $u,w$ и $H\in\mathbb R^{M\times Q}$ (сотни КБ/МБ), вместо $Z\in\mathbb C^{S\times F}$ (сотни МБ/ГБ) и $Y\in\mathbb R^{M\times F}$. 
* **Оффлайн-стоимость $=O(MQ)$** вызовов ${}_1F_1$ плюс линейная склейка; онлайн $=O(MQ)+O(MS)$. У классики оффлайн нет, но онлайн — суммирование по $k$ (или крупная $Z$), что и заменено тут на компактные $Q$. 
* **Инкрементальность.** Новый вклад = новая строка $H_{j,:}$, без пересборки чего-либо глобального. 

---

## Резюме «One-Shot online memory (QTail-версия)»

* **Пред-расчёт (one-shot):** узлы/веса GL ($Q$), константы $a,b,\kappa,K_D$, матрица $H_{M\times Q}$.
* **Что храним:** $u,w,H$ и канонные $\{\alpha_j,\hat T_j\}$ (рамки — опционально).
* **Онлайн:** для запроса $(z,\vec d)$ — формируем $\psi_j\in\mathbb R^Q$, берём одно **скалярное произведение** $H_{j,:}\!\cdot\!\psi_j$ на вклад и суммируем по $j$; направленческий множитель — как в каноне (одна экспонента).
* **Добавление вклада:** одна строка $H$ + $\alpha_j,\hat T_j$; всё остальное — неизменно.

Весь вывод строго следует из канона (A.2–A.9) и конструкций T_PD_MF_QTail (§§1–4: разложение «$n=0$+хвост», сферические средние, редукция к GL-квадратуре; §8 — чек-лист реализации).

Если хотите, оформлю это как отдельный раздел «CPSF — One-Shot online memory (QTail)» в канвасе: формулировки лемм/теорем, минимальные предпосылки и оценка $\varepsilon(Q)$ с явным контролем по $a,b,D$ — строго в текущих обозначениях.
