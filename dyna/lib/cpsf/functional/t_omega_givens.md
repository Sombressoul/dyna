CPSF_STRICT_MODE ENGAGED.

Ок — фиксируем **точные условия задачи** и что **дано** (без новых сущностей, в вашей терминологии).

# 1) Геометрия и размерности

* Пространство комплексное: (z\in\mathbb C^N), эквивалентно (\mathbb R^{D}) с (D=2N).
* Для источника (j): (z_j\in\mathbb C^N), (\vec d_j\in\mathbb C^N). Текущий запрос: (z,\ \vec d).
* Каноническое вложение (\iota) ((\mathbb C^N\to\mathbb R^{2N})) используется, но **матрицы вращений не строятся**.

# 2) Входные данные (по партиям)

* (z:[B,N]) (complex), (z_j:[B,M,N]) (complex).
* (\vec d:[B,N]), (\vec d_j:[B,M,N]) — того же dtype, что и (z).
* (\alpha_j:[B,M]) (real).
* (\sigma_{\parallel},\sigma_{\perp}:[B,M]) (real, **строго >0**).
* (\hat T_j:[B,M,S]) (complex).
* Предполагаем (\vec d_j\neq 0) (для единичного направления).

# 3) Нормализованные направления и сдвиги

* (u_j := \vec d_j/|\vec d_j|) — единичный вектор направления источника.
* (x := z_j - z \in \mathbb R^{D}) (через (\iota)); (r:=|x|); (c:=\langle x,u_j\rangle).

# 4) Параметризация анизотропии (строго линейно по (1/\sigma))

* (a := \sigma_{\perp}^{-1}),\quad (b := \sigma_{\parallel}^{-1}-\sigma_{\perp}^{-1}).
* Ранг-1 метрика без поворотов: (G := a,I + b,u_j u_j^{\top}) (в реальном (D)-мерном представлении).
* **Нет (\sigma^2)** нигде в формулах.

# 5) Что именно периодизуется / не периодизуется

* Периодизуется **только позиционный блок** (по (x)).
* Направленческий блок **не** периодизуется: он даёт один конечный множитель
  [
  A_{\mathrm{dir},j};=;\exp!\big(-\pi,q(,\iota(0,\ \delta\vec d),)\big),\quad \delta\vec d:=\vec d-\vec d_j.
  ]

# 6) Нулевой фрейм (точно известный и уже валидирован)

* Квадратичная форма позиционного ядра:
  [
  q_{\text{pos}}(x)=a,r^2 + b,|c|^2.
  ]
* Точный множитель нулевого кадра:
  [
  A_{\text{pos}}(z);=;\exp!\big(-\pi,q_{\text{pos}}(x)\big).
  ]
* Нулевой фрейм численно совпадает с «классикой» в машинных пределах (ваши метрики точности приняты как эталон). Это «дано» и не требует аппроксимации.

# 7) Хвост периодизации — объект вычисления

* Требуется вычислить **чисто позиционный хвост**
  [
  \Theta^{\mathrm{tail}}*{\mathrm{real}}(x);=;\sum*{n\in\mathbb Z^D\setminus{0}}
  \exp!\big(-\pi,(x+n)^{\top}G,(x+n)\big),
  ]
  и получить (\Theta^{(\mathrm{pos})}(x)\approx A_{\text{pos}}(x),[1+S_{\text{tail}}(x)]) с заданной точностью.

# 8) Закрытые формы угловых средних (дано как тождества)

* При разложении по оболочкам радиуса (\rho=|n|) и усреднении по сфере:

  * (\big\langle e^{-\pi b\rho^2\cos^2\theta}\big\rangle = {}_1F_1(\tfrac12;\tfrac D2;,-\pi b\rho^2)).
  * (\big\langle e^{-2\pi m\rho\cos\phi}\big\rangle = \Gamma(\tfrac D2)\big(\tfrac{2}{2\pi m\rho}\big)^{\nu} I_{\nu}(2\pi m\rho)), где (\nu=\tfrac D2-1).
* Вспомогательные величины: (v:=a,x + b,c,u_j), (m:=|v|).

# 9) Радиа́льная переменная и форма интеграла (дано)

* Замена (u=\pi a,\rho^2) даёт вес (u^{\nu}e^{-u}) и 1D-интеграл вида
  [
  \mathcal T(x)=K_D(a)!\int_{0}^{\infty}! u^{\nu}e^{-u};\underbrace{{}*1F_1!\big(\tfrac12;\tfrac D2;-\kappa u\big)}*{\kappa=b/a};\underbrace{\zeta(u)^{-\nu}I_\nu(\zeta(u))}_{\zeta(u)=2\sqrt{\pi},m,a^{-1/2}u^{1/2}},du,
  ]
  где (K_D(a)) — известная константа от (D) и (a).

# 10) Точная численная форма без «чёрной» спецфункции (дано)

* Для целочисленных (N):
  [
  {}*1F_1!\big(\tfrac12;N;-!x\big)=e^{-x}!\left[A_N,\mathrm{erfcx}(\sqrt{x})+x^{\frac12-N}P*{N-1}(x)\right],
  ]
  с корректным переключением на ряд Маклорена при малых (x).
* Бессель берётся в **скейленной** форме (\widetilde I_\nu(\zeta):=e^{-\zeta}I_\nu(\zeta)) (кусково: ряд/Чебышёв/асимптотика) — это **вычислительная форма**, не меняющая математику.

# 11) «Остаточный» интегранд (дано)

* Интегрируем не «всё», а разность с нулевым кадром:
  [
  \mathcal I_{\text{tail}}(u);=; e^{-(1+\kappa)u}!\left[A_N,\mathrm{erfcx}(\sqrt{\kappa u})+(\kappa u)^{\frac12-N}P_{N-1}(\kappa u)\right]!\cdot!\widetilde I_\nu(\zeta(u)) ;-; e^{-u},\mathcal H_0(u),
  ]
  что резко уменьшает требуемые (U_\star) и (Q).

# 12) Точностные требования (дано как контракт)

* Целевой допуск (\varepsilon_{\text{tot}}) (для хвоста) фиксируется заранее.
* Выбор числа узлов (Q) и порога обрезания (U_\star) обеспечивает:
  [
  \big|\textstyle\sum_{q=1}^{Q} w_q^{(\nu)},\mathcal I_{\text{tail}}(u_q);+;R(U_\star);-;\int_0^\infty \mathcal I_{\text{tail}}(u),u^{\nu}e^{-u}du\big|\ \le\ \varepsilon_{\text{tot}}.
  ]

# 13) Оценка остатка и выбор (U_\star) (дано)

* Универсальная верхняя оценка:
  [
  |\mathcal I_{\text{tail}}(u)|\ \le\ e^{-(1+\kappa)u},\Big[C_0,u^{-1/2}+\sum_{k=0}^{N-1} C_k,u^{k+\tfrac12-N}\Big].
  ]
* Критерий выбора:
  [
  e^{-(1+\kappa)U_\star},\sum_j D_j,U_\star^{\beta_j}\ \le\ \varepsilon_{\text{tot}},
  ]
  где (D_j,\beta_j) — известные (из той же оценки) константы; решается за 1–2 шага по одному скаляру.

# 14) Ресурсные/имплементационные ограничения (дано)

* **Матрицы не материализуются**; всё в терминах норм/проекций и 1D-квадратуры.
* Память: ( \mathcal O(B,M + B,S)) без решёток (\mathbb Z^D).
* Время: (\mathcal O(B,M,Q)) на хвост.
* В численной реализации должны быть устойчивые ветки для: малых/больших (x) в ({}*1F_1); малых/больших (\zeta) в (I*\nu); изотропного случая (b=0) ((\kappa=0)).

# 15) Выход и сборка вклада источника

* Позиционная часть: (\Theta^{(\mathrm{pos})}(x)\approx A_{\text{pos}}(x),[1+S_{\text{tail}}(x)]).
* Полный вклад источника (j):
  [
  \eta_j(z,\vec d);=;\Theta^{(\mathrm{pos})}(x);\cdot;A_{\mathrm{dir},j},\qquad
  T(z,\vec d);=;\sum_{j}\alpha_j,\mathrm{Re}{\eta_j(z,\vec d)},\hat T_j.
  ]

Если что-то из перечисленного ты хочешь сформулировать иначе (другой порядок, нотация, акценты) — правь, и я сразу подстрою всё остальное под твою формулировку 1:1.
